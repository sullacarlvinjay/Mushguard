{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mushroom Detector</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/base.css' %}">
</head>
<body>
   
<section class="hero-section py-5">
    <div class="container mt-5">
        <div class="mb-3">
            <a href="/" class="btn btn-success btn-sm">
                Back to Homepage
            </a>
        </div>
        <div class="row justify-content-center">
            <div class="col-md-8">
                <!-- Info and Warning Buttons -->
                <div class="action-buttons-container">
                    <button type="button" class="btn btn-info info-button" data-bs-toggle="modal" data-bs-target="#infoModal">
                        <i class="fas fa-info-circle"></i>
                    </button>
                    <button type="button" class="btn btn-warning warning-button" data-bs-toggle="modal" data-bs-target="#warningModal">
                        <i class="fas fa-exclamation-triangle"></i>
                    </button>
                </div>

                <!-- Warning Modal -->
                <div class="modal fade" id="warningModal" tabindex="-1" aria-labelledby="warningModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header warning-header">
                                <h5 class="modal-title" id="warningModalLabel">
                                    <i class="fas fa-exclamation-triangle text-warning"></i> Dataset Limitations
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="warning-content">
                                    <div class="warning-section">
                                        <h6><i class="fas fa-database"></i> Dataset Information</h6>
                                        <p>This system is trained on a limited dataset of approximately 1,000 mushroom images.</p>
                                    </div>

                                    <div class="species-section">
                                        <h6><i class="fas fa-leaf text-success"></i> Edible Species in Dataset</h6>
                                        <ul class="species-list edible">
                                            <li><span class="species-name">Apioperdon pyriforme</span> (Pear-shaped Puffball)</li>
                                            <li><span class="species-name">Cerioporus squamosus</span> (Dryad's Saddle)</li>
                                            <li><span class="species-name">Coprinellus micaceus</span> (Mica Cap)</li>
                                            <li><span class="species-name">Coprinus comatus</span> (Shaggy Mane)</li>
                                            <li><span class="species-name">Lactarius torminosus</span> (Woolly Milk Cap)</li>
                                        </ul>
                                    </div>

                                    <div class="species-section">
                                        <h6><i class="fas fa-skull-crossbones text-danger"></i> Poisonous Species in Dataset</h6>
                                        <ul class="species-list poisonous">
                                            <li><span class="species-name">Amanita muscaria</span> (Fly Agaric)</li>
                                            <li><span class="species-name">Bjerkandera adusta</span> (Smoky Bracket)</li>
                                            <li><span class="species-name">Gyromitra gigas</span> (Snow Morel)</li>
                                            <li><span class="species-name">Gyromitra infula</span> (Hooded False Morel)</li>
                                            <li><span class="species-name">Xanthoria parietina</span> (Common Orange Lichen)</li>
                                        </ul>
                                    </div>

                                    <div class="warning-note">
                                        <h6><i class="fas fa-exclamation-circle"></i> Important Limitations</h6>
                                        <ul>
                                            <li>The system can only identify mushrooms within these 10 species</li>
                                            <li>Accuracy may be affected for mushrooms not in the dataset</li>
                                            <li>Results should be verified by experts before consumption</li>
                                            <li>System is for educational purposes only</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Info Modal -->
                <div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="infoModalLabel">
                                    <i class="fas fa-magic text-primary"></i> How It Works
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="info-steps">
                                    <div class="info-step">
                                        <div class="step-icon">
                                            <i class="fas fa-camera-retro"></i>
                                        </div>
                                        <div class="step-content">
                                            <h6>1. Choose Your Input Method</h6>
                                            <p>Start by selecting how you want to analyze your mushroom:</p>
                                            <ul class="feature-list">
                                                <li><i class="fas fa-upload text-primary"></i> Upload a clear image from your device</li>
                                                <li><i class="fas fa-camera text-success"></i> Take a live photo using your camera</li>
                                            </ul>
                                            <div class="step-tip">
                                                <i class="fas fa-lightbulb"></i> Tip: Ensure good lighting and a clear view of the mushroom
                                            </div>
                                        </div>
                                    </div>

                                    <div class="info-step">
                                        <div class="step-icon">
                                            <i class="fas fa-brain"></i>
                                        </div>
                                        <div class="step-content">
                                            <h6>2. AI Analysis Process</h6>
                                            <p>Our advanced AI model goes through multiple stages:</p>
                                            <div class="process-steps">
                                                <div class="process-step">
                                                    <span class="process-number">1</span>
                                                    <span>Image Preprocessing</span>
                                                </div>
                                                <div class="process-step">
                                                    <span class="process-number">2</span>
                                                    <span>Feature Extraction</span>
                                                </div>
                                                <div class="process-step">
                                                    <span class="process-number">3</span>
                                                    <span>Classification</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="info-step">
                                        <div class="step-icon">
                                            <i class="fas fa-shield-alt"></i>
                                        </div>
                                        <div class="step-content">
                                            <h6>3. Edibility Check</h6>
                                            <p>The system first determines if the mushroom is safe to consume:</p>
                                            <div class="result-preview edible">
                                                <i class="fas fa-check-circle"></i>
                                                <span>Edible with confidence score</span>
                                            </div>
                                            <div class="result-preview poisonous">
                                                <i class="fas fa-skull-crossbones"></i>
                                                <div class="poisonous-info">
                                                    <span class="warning-title">Poisonous Mushroom Detected</span>
                                                    <div class="safety-advice">
                                                        <div class="advice-item">
                                                            <i class="fas fa-hand-paper"></i>
                                                            <span>Do not touch or handle the mushroom</span>
                                                        </div>
                                                        <div class="advice-item">
                                                            <i class="fas fa-ban"></i>
                                                            <span>Do not attempt to consume</span>
                                                        </div>
                                                        <div class="advice-item">
                                                            <i class="fas fa-phone-alt"></i>
                                                            <span>Contact poison control if ingested</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="info-step">
                                        <div class="step-icon">
                                            <i class="fas fa-search"></i>
                                        </div>
                                        <div class="step-content">
                                            <h6>4. Species Identification</h6>
                                            <p>For edible mushrooms, we identify the specific species:</p>
                                            <div class="species-preview">
                                                <div class="species-card">
                                                    <i class="fas fa-leaf"></i>
                                                    <div class="species-info">
                                                        <strong>Species Name</strong>
                                                        <span>Common Name</span>
                                                    </div>
                                                </div>
                                                <div class="species-details">
                                                    <div class="detail-item">
                                                        <i class="fas fa-chart-line"></i>
                                                        <span>Confidence Score</span>
                                                    </div>
                                                    <div class="detail-item">
                                                        <i class="fas fa-clock"></i>
                                                        <span>Lifespan</span>
                                                    </div>
                                                    <div class="detail-item">
                                                        <i class="fas fa-box"></i>
                                                        <span>Preservation</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="info-step">
                                        <div class="step-icon">
                                            <i class="fas fa-clipboard-check"></i>
                                        </div>
                                        <div class="step-content">
                                            <h6>5. Results & Recommendations</h6>
                                            <p>Get detailed analysis results including:</p>
                                            <div class="results-grid">
                                                <div class="result-item">
                                                    <i class="fas fa-percentage"></i>
                                                    <span>Confidence Level</span>
                                                </div>
                                                <div class="result-item">
                                                    <i class="fas fa-info-circle"></i>
                                                    <span>Species Details</span>
                                                </div>
                                                <div class="result-item">
                                                    <i class="fas fa-exclamation-triangle"></i>
                                                    <span>Safety Warnings</span>
                                                </div>
                                                <div class="result-item">
                                                    <i class="fas fa-book"></i>
                                                    <span>Additional Info</span>
                                                </div>
            </div>
        </div>
    </div>
    
                                <div class="info-step warning-step">
                                    <div class="step-icon warning">
                                        <i class="fas fa-exclamation-circle"></i>
                                    </div>
                                    <div class="step-content">
                                        <h6>Important Note</h6>
                                        <p>This system is for educational purposes only. Always consult with experts before consuming any wild mushrooms.</p>
                                        <div class="warning-highlight">
                                            <i class="fas fa-user-md"></i>
                                            <span>Expert verification is essential for safety</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
            </div>
                </div>
                </div>
            </div>

            <div class="card mushroom-card">
                <div class="card-body">
                    <h2 class="text-center mb-4 card-title d-flex flex-column align-items-center justify-content-center gap-3">
                        <img src="{% get_media_prefix %}logo/logo.png" alt="MushGuard logo" style="height: 130px; width: auto;">
                        <span class="fw-bold">MUSHGUARD</span>
                    </h2>
                    
                    <!-- Input Mode Toggle -->
                    <div class="input-mode-toggle mb-4">
                        <div class="btn-group w-100" role="group">
                            <button type="button" class="btn btn-outline-success active" id="upload-mode-btn">
                                <i class="fas fa-upload"></i> Upload Image
                            </button>
                            <button type="button" class="btn btn-outline-success" id="camera-mode-btn">
                                <i class="fas fa-camera"></i> Take Photo
                            </button>
                        </div>
                    </div>

                    <!-- Input Container (Shared by both modes) -->
                    <div class="input-container">
                        <!-- Upload Mode -->
                        <div class="input-mode" id="upload-mode">
                            <form method="post" enctype="multipart/form-data" class="mb-4" id="upload-form">
                                {% csrf_token %}
                                <div class="form-group">
                                    {{ form.image.label_tag }}
                                    {{ form.image }}
                                    {% if form.image.errors %}
                                        <div class="alert alert-danger">{{ form.image.errors }}</div>
                                    {% endif %}
                                </div>
                                
                                <!-- Image Preview Section -->
                                <div class="image-preview-container" style="display: none;">
                                    <div class="preview-header">
                                        <h4>Image Preview</h4>
                                    </div>
                                    <div class="preview-image-wrapper">
                                        <img id="image-preview" src="#" alt="Preview" class="img-fluid">
                                    </div>
                                </div>
                                
                                <button type="submit" class="btn btn-success btn-block analyze-btn">Analyze Image</button>
                            </form>
                        </div>

                        <!-- Camera Mode -->
                        <div class="input-mode" id="camera-mode" style="display: none;">
                            <div class="camera-container">
                                <video id="camera-feed" autoplay playsinline></video>
                                <canvas id="camera-canvas" style="display: none;"></canvas>
                            </div>
                            <div class="camera-controls mt-3">
                                <button id="start-camera" class="btn btn-primary btn-block">
                                    <i class="fas fa-camera"></i> Start Camera
                                </button>
                                <button id="capture-photo" class="btn btn-success btn-block" disabled>
                                    <i class="fas fa-camera-retro"></i> Capture Photo
                                </button>
                            </div>
                            <div class="image-preview-container mt-3" style="display: none;">
                                <div class="preview-header">
                                    <h4>Camera Preview</h4>
                                </div>
                                <div class="preview-image-wrapper">
                                    <img id="camera-preview" src="#" alt="Camera Preview" class="img-fluid">
                                </div>
                                <form id="camera-form" method="post" enctype="multipart/form-data" class="mt-3">
                                    {% csrf_token %}
                                    <input type="hidden" name="camera_image" id="camera-image-input">
                                    <button type="submit" class="btn btn-success btn-block analyze-btn">Analyze Photo</button>
                                </form>
        </div>
    </div>
</div>

<div id="analysis-result-container">
{% if result %}
            {% if result.error %}
            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle"></i> {{ result.error }}
                            </div>
                        {% elif result.preliminary_passed == False %}
                            {% if result.message == 'Image is not a mushroom. Please upload another image.' %}
                                <div class="analysis-result">
                                    <div class="result-header">
                                        <h3>
                                            <i class="fas fa-times-circle text-danger"></i> Image is not a mushroom
                                        </h3>
                                    </div>
                                    <div class="alert alert-warning mt-3">
                                        <h5><i class="fas fa-info-circle"></i> Please try again</h5>
                                        <p>{{ result.message }}</p>
                                    </div>
                                </div>
                            {% else %}
                                <div class="analysis-result">
                                    <div class="result-header">
                                        <h3>
                                            <i class="fas fa-question-circle text-warning"></i> Mushroom Not in Dataset
                                        </h3>
                                        <div class="confidence">
                                            Confidence: <span class="confidence-value">{{ result.confidence }}%</span>
                                        </div>
                                    </div>
                                    <div class="alert alert-warning mt-3">
                                        <h5><i class="fas fa-info-circle"></i> Analysis Result</h5>
                                        <p>{{ result.message }}</p>
                                        <p><strong>Recommendation:</strong> This mushroom is not included in our current dataset. Please consult with a mycologist or expert for proper identification.</p>
                                    </div>

                                    <!-- Inline Report Form -->
                                    <div class="card p-3 mt-3">
                                        <h5 class="mb-3">Report this mushroom</h5>
                                        <form method="post" action="/report/" enctype="multipart/form-data">
                                            {% csrf_token %}
                                            <div class="row g-3">
                                                <div class="col-md-6">
                                                    <label class="form-label">Species Name</label>
                                                    {{ unknown_form.name }}
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">Upload Image</label>
                                                    {{ unknown_form.image }}
                                                </div>
                                                <div class="col-12">
                                                    <label class="form-label">Description</label>
                                                    {{ unknown_form.description }}
                                                </div>
                                                <div class="col-12">
                                                    <label class="form-label">Pinpoint Location (Biliran, Philippines)</label>
                                                    <div id="unknown-map" style="height: 360px; border-radius: 8px; overflow: hidden;"></div>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">Latitude</label>
                                                    {{ unknown_form.latitude }}
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">Longitude</label>
                                                    {{ unknown_form.longitude }}
                                                </div>
                                            </div>
                                            <button type="submit" class="btn btn-success mt-3">Submit Report</button>
                                        </form>
                                    </div>
                                    
                                    <!-- Leaflet CSS -->
                                    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
                                    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
                                    <script>
                                (function() {
                                    // Wait briefly for DOM rendering before initializing map
                                    setTimeout(function() {
                                        const mapEl = document.getElementById('unknown-map');
                                        if (!mapEl) {
                                            console.warn('Map container #unknown-map not found');
                                            return;
                                        }
                                        
                                        // Fix Leaflet default icon path if needed
                                        if (typeof L !== 'undefined') {
                                            delete L.Icon.Default.prototype._getIconUrl;
                                            L.Icon.Default.mergeOptions({
                                                iconRetinaUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon-2x.png',
                                                iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon.png',
                                                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                                            });
                                        } else {
                                            console.error('Leaflet library not loaded');
                                            return;
                                        }
                                        
                                        // Biliran Province approx bounds
                                        const southWest = L.latLng(11.40, 124.20);
                                        const northEast = L.latLng(11.75, 124.70);
                                        const bounds = L.latLngBounds(southWest, northEast);
                                        const center = [11.58, 124.50];
                                        
                                        const map = L.map('unknown-map', {
                                            center: center,
                                            zoom: 11,
                                            maxBounds: bounds,
                                            maxBoundsViscosity: 1.0
                                        });
                                        
                                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                            attribution: '&copy; OpenStreetMap contributors',
                                            maxZoom: 19
                                        }).addTo(map);
                                        
                                        // Force map to recalculate size after container is rendered
                                        setTimeout(function() {
                                            map.invalidateSize();
                                        }, 100);
                                        
                                        map.whenReady(function() {
                                            let marker = null;
                                            const latInput = document.getElementById('{{ unknown_form.latitude.id_for_label }}') || document.querySelector('input[name="latitude"]');
                                            const lonInput = document.getElementById('{{ unknown_form.longitude.id_for_label }}') || document.querySelector('input[name="longitude"]');
                                            
                                            if (!latInput || !lonInput) {
                                                console.error('Input fields not found for map');
                                                return;
                                            }
                                            
                                            function setLatLon(latlng) {
                                                if (latInput) latInput.value = latlng.lat.toFixed(6);
                                                if (lonInput) lonInput.value = latlng.lng.toFixed(6);
                                                console.log('Coordinates set:', latlng.lat, latlng.lng);
                                            }
                                            
                                            map.on('click', function(e) {
                                                const latlng = e.latlng;
                                                console.log('Map clicked at:', latlng);
                                                
                                                if (marker) {
                                                    marker.setLatLng(latlng);
                                                } else {
                                                    marker = L.marker(latlng, {
                                                        draggable: true,
                                                        autoPan: true
                                                    }).addTo(map);
                                                    
                                                    marker.off('dragend');
                                                    marker.on('dragend', function(ev) {
                                                        const draggedLatLng = ev.target.getLatLng();
                                                        console.log('Marker dragged to:', draggedLatLng);
                                                        setLatLon(draggedLatLng);
                                                    });
                                                }
                                                
                                                setLatLon(latlng);
                                            });
                                        });
                                    }, 150); // Delay to ensure DOM is painted
                                })();
                                </script>
                            </div>
                            {% endif %}
                        {% else %}
                            <div class="analysis-result {% if result.is_edible %}edible{% else %}poisonous{% endif %}">
                                <div class="result-header">
                                    <h3>
                                        {% if result.is_edible %}
                                            <i class="fas fa-check-circle text-success"></i> Edible
                                        {% else %}
                                            <i class="fas fa-skull-crossbones text-danger"></i> Poisonous
                                        {% endif %}
                                    </h3>
                                    <div class="confidence">
                                        Confidence: <span class="confidence-value">{{ result.edibility_confidence }}%</span>
                                    </div>
                                </div>

                                {% if result.is_edible and result.species %}
                                    <div class="species-info">
                                        <h4>Species Analysis</h4>
                                        <div class="info-grid">
                                            <div class="info-item">
                                                <span class="label">Species:</span>
                                                <span class="value">{{ result.species }}</span>
                                            </div>
                                            <div class="info-item">
                                                <span class="label">Confidence:</span>
                                                <span class="value">{{ result.species_confidence }}%</span>
                                            </div>
                                            <div class="info-item">
                                                <span class="label">Lifespan:</span>
                                                <span class="value">{{ result.lifespan }}</span>
                                            </div>
                                            <div class="info-item">
                                                <span class="label">Preservation:</span>
                                                <span class="value">{{ result.preservation }}</span>
                                            </div>
                                        </div>
            </div>
            {% else %}
                                    {% if not result.is_edible %}
                                        <div class="poisonous-warning">
                                            <div class="warning-header">
                                                <i class="fas fa-exclamation-triangle"></i>
                                                <h4>Safety Warning</h4>
                                            </div>
                                            <div class="warning-content">
                                                <div class="warning-section">
                                                    <h5><i class="fas fa-hand-paper"></i> Immediate Actions</h5>
                                                    <ul>
                                                        <li>Do not touch or handle the mushroom</li>
                                                        <li>Keep children and pets away from the area</li>
                                                        <li>If already handled, wash hands thoroughly</li>
                                                    </ul>
                                                </div>
                                                
                                                <div class="warning-section">
                                                    <h5><i class="fas fa-phone-alt"></i> Emergency Contact</h5>
                                                    <div class="emergency-info">
                                                        <p>If you suspect mushroom poisoning:</p>
                                                        <ul>
                                                            <li>Call Poison Control immediately: <strong>1-800-222-1222</strong></li>
                                                            <li>Do not wait for symptoms to appear</li>
                                                            <li>Save a sample of the mushroom if possible</li>
                                                        </ul>
                                                    </div>
                                                </div>

                                                <div class="warning-section">
                                                    <h5><i class="fas fa-shield-alt"></i> Prevention Tips</h5>
                                                    <ul>
                                                        <li>Never consume wild mushrooms without expert identification</li>
                                                        <li>Teach children not to touch or eat wild mushrooms</li>
                                                        <li>Regularly check your yard for poisonous mushrooms</li>
                                                        <li>When in doubt, assume a mushroom is poisonous</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    {% endif %}
                                {% endif %}
                </div>
                    {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
</section>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="{% static 'js/base.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    function clearResults() {
        const container = document.getElementById('analysis-result-container');
        if (container) {
            container.innerHTML = '';
        }
    }

    const uploadBtn = document.getElementById('upload-mode-btn');
    const cameraBtn = document.getElementById('camera-mode-btn');

    if (uploadBtn) {
        uploadBtn.addEventListener('click', clearResults);
    }

    if (cameraBtn) {
        cameraBtn.addEventListener('click', clearResults);
    }
});
</script>
</body>
</html>