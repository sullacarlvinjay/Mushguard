{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ mushroom_name }} - MushGuard</title>
    <link rel="icon" type="image/png" href="{% get_media_prefix %}logo/favicon.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/base.css' %}">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <img src="/media/logo/logo.png" alt="MushGuard" />
                <span class="brand-text">MUSHGUARD</span>
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">
                    <i class="fas fa-arrow-left me-2"></i>Back to Map
                </a>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        {% if error %}
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>{{ error }}
            </div>
        {% else %}
            <div class="row">
                <!-- Main Content -->
                <div class="col-lg-8">
                    <div class="card mb-4">
                        <div class="card-body text-center">
                            <div class="mb-4">
                                <p class="text-uppercase text-muted small mb-1">Name</p>
                                <h2 class="card-title mb-3">
                                    <i class="fas fa-mushroom text-success me-2"></i>
                                    <span id="location-name-text">{{ primary_mushroom.name }}</span>
                                </h2>
                                <span id="location-status-badge" class="badge bg-{{ primary_mushroom.status }} fs-6 px-3 py-2 shadow-sm">
                                    {% if primary_mushroom.status == 'edible' %}
                                        <i class="fas fa-leaf me-1"></i>Edible
                                    {% elif primary_mushroom.status == 'poisonous' %}
                                        <i class="fas fa-skull-crossbones me-1"></i>Poisonous
                                    {% elif primary_mushroom.status == 'unknown' %}
                                        <i class="fas fa-question-circle me-1"></i>Unknown
                                    {% else %}
                                        <i class="fas fa-map-marker-alt me-1"></i>Mapped
                                    {% endif %}
                                </span>
                            </div>
                            <div class="row g-3 mb-4 text-start">
                                <div class="col-md-4">
                                    <div class="p-3 mush-detail-box h-100">
                                        <p class="text-uppercase text-muted small mb-2 mush-detail-label">Description</p>
                                        {% if primary_mushroom.description %}
                                            <p id="location-description" class="mb-0 mush-detail-value">{{ primary_mushroom.description }}</p>
                                        {% else %}
                                            <p id="location-description" class="mb-0 text-muted">No description provided.</p>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="p-3 mush-detail-box h-100">
                                        <p class="text-uppercase text-muted small mb-2 mush-detail-label">Scientific Name</p>
                                        {% if primary_mushroom.scientific_name %}
                                            <p id="location-scientific-name" class="mb-0 mush-detail-value">{{ primary_mushroom.scientific_name }}</p>
                                        {% else %}
                                            <p id="location-scientific-name" class="mb-0 text-muted">Not specified.</p>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="p-3 mush-detail-box h-100">
                                        <p class="text-uppercase text-muted small mb-2 mush-detail-label">Origin / Habitat</p>
                                        {% if primary_mushroom.origin %}
                                            <p id="location-origin" class="mb-0 mush-detail-value">{{ primary_mushroom.origin }}</p>
                                        {% else %}
                                            <p id="location-origin" class="mb-0 text-muted">No origin information provided.</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <div class="ratio ratio-4x3 mb-4" style="max-width: 420px; margin: 0 auto; border-radius: 15px; overflow: hidden;">
                                <img id="location-image" src="{{ primary_mushroom.image.url }}" class="w-100 h-100" alt="{{ primary_mushroom.name }}" style="object-fit: cover;">
                            </div>

                            <div class="row g-3 text-start">
                                <div class="col-md-6">
                                    <div class="p-3 bg-light rounded h-100">
                                        <p class="text-uppercase text-muted small mb-1">Coordinates</p>
                                        <p id="location-coords" class="mb-0 fw-semibold">
                                            <i class="fas fa-map-marker-alt me-2"></i>
                                            {{ primary_mushroom.latitude|floatformat:4 }}, {{ primary_mushroom.longitude|floatformat:4 }}
                                        </p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="p-3 bg-light rounded h-100">
                                        <p class="text-uppercase text-muted small mb-1">Submitted</p>
                                        <p id="location-date" class="mb-0 fw-semibold">
                                            <i class="fas fa-clock me-2"></i>{{ primary_mushroom.created_at|date:'M d, Y' }}
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-4">
                                <h5 class="text-uppercase text-muted small mb-3">All Locations for {{ primary_mushroom.name }}</h5>
                                <div class="list-group location-list shadow-sm rounded overflow-hidden">
                                    {% for mushroom in mushrooms %}
                                        <button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center location-item {% if forloop.first %}active{% endif %}" data-index="{{ forloop.counter0 }}">
                                            <div>
                                                <span class="fw-semibold">{{ mushroom.latitude|floatformat:4 }}, {{ mushroom.longitude|floatformat:4 }}</span>
                                                <small class="text-muted d-block">Added {{ mushroom.created_at|date:'M d, Y' }}</small>
                                            </div>
                                            <i class="fas fa-chevron-right text-muted"></i>
                                        </button>
                                    {% empty %}
                                        <div class="list-group-item text-center text-muted">No other locations available.</div>
                                    {% endfor %}
                                </div>
                                <small class="d-block mt-2 text-muted">Tap a location to highlight it on the map.</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sidebar with Map -->
                <div class="col-lg-4">
                    <div class="card sticky-top" style="top: 2rem;">
                        <div class="card-body">
                            <h5 class="card-title mb-3">
                                <i class="fas fa-map me-2"></i>Locations
                            </h5>
                            <div id="mushroom-locations-map" style="height: 520px; border-radius: 15px; overflow: hidden;"></div>
                            <div class="mt-3">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    {{ locations_count }} location{{ locations_count|pluralize }} found for this species
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>

    <!-- Leaflet CSS and JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Mushroom locations data -->
    <script type="application/json" id="mushroom-locations-data">[
        {% for mushroom in mushrooms %}
        {
            "lat": {{ mushroom.latitude }},
            "lng": {{ mushroom.longitude }},
            "name": "{{ mushroom.name|escapejs }}",
            "description": "{{ mushroom.description|escapejs }}",
            "scientific_name": "{{ mushroom.scientific_name|escapejs }}",
            "origin": "{{ mushroom.origin|escapejs }}",
            "image": "{{ mushroom.image.url }}",
            "date": "{{ mushroom.created_at|date:'M d, Y' }}",
            "status": "{{ mushroom.status }}",
            "color": "{{ mushroom.pin_color|default:'#0d6efd' }}"
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ]</script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const mapEl = document.getElementById('mushroom-locations-map');
        if (!mapEl) return;

        // Fix Leaflet default icon path
        delete L.Icon.Default.prototype._getIconUrl;
        L.Icon.Default.mergeOptions({
            iconRetinaUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon-2x.png',
            iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
        });

        // Biliran Province bounds
        const southWest = L.latLng(11.40, 124.20);
        const northEast = L.latLng(11.75, 124.70);
        const bounds = L.latLngBounds(southWest, northEast);

        // Get mushroom locations from JSON data
        let locations = [];
        try {
            const dataEl = document.getElementById('mushroom-locations-data');
            if (dataEl && dataEl.textContent.trim()) {
                locations = JSON.parse(dataEl.textContent);
            }
        } catch (e) {
            console.error('Failed to parse mushroom locations data:', e);
        }

        // Calculate center from locations or use default
        let center = [11.58, 124.50];
        if (locations.length > 0) {
            const latSum = locations.reduce((sum, loc) => sum + loc.lat, 0);
            const lngSum = locations.reduce((sum, loc) => sum + loc.lng, 0);
            center = [latSum / locations.length, lngSum / locations.length];
        }

        // Initialize map
        const map = L.map('mushroom-locations-map', {
            center: center,
            zoom: locations.length === 1 ? 15 : 12,
            maxBounds: bounds,
            maxBoundsViscosity: 1.0
        });

        // Add tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        const markers = [];

        // Add markers for each location
        locations.forEach(function(loc, index) {
            const marker = L.marker([loc.lat, loc.lng]).addTo(map);
            markers.push(marker);
            
            const popupContent = `
                <div style="width: 200px;">
                    <img src="${loc.image}" alt="${loc.name}" style="width: 100%; height: 120px; object-fit: cover; border-radius: 6px; margin-bottom: 8px;"/>
                    <strong>${loc.name}</strong><br/>
                    ${loc.description ? `<small class=\"text-muted\">${loc.description}</small><br/>` : ''}
                    <small class="text-muted">
                        <i class="fas fa-clock"></i> ${loc.date}<br/>
                        <i class="fas fa-map-marker-alt"></i> ${loc.lat.toFixed(4)}, ${loc.lng.toFixed(4)}
                    </small>
                </div>
            `;
            
            marker.bindPopup(popupContent);

            // When clicking a marker, also update the side details panel and active location
            marker.on('click', function() {
                try {
                    const buttons = document.querySelectorAll('.location-item');
                    if (buttons && buttons[index]) {
                        buttons.forEach(function(btn) { btn.classList.remove('active'); });
                        buttons[index].classList.add('active');
                    }
                } catch (e) {}
                updateLocationDetails(loc);
            });
        });

        // Fit map to show all markers if multiple locations
        if (markers.length > 1) {
            const group = L.featureGroup(markers);
            map.fitBounds(group.getBounds().pad(0.1));
        }

        const locationButtons = document.querySelectorAll('.location-item');
        const detailName = document.getElementById('location-name-text');
        const detailBadge = document.getElementById('location-status-badge');
        const detailDescription = document.getElementById('location-description');
        const detailScientific = document.getElementById('location-scientific-name');
        const detailOrigin = document.getElementById('location-origin');
        const detailImage = document.getElementById('location-image');
        const detailCoords = document.getElementById('location-coords');
        const detailDate = document.getElementById('location-date');

        const statusLabelMap = {
            mapped: '<i class="fas fa-map-marker-alt me-1"></i>Mapped',
            edible: '<i class="fas fa-leaf me-1"></i>Edible',
            poisonous: '<i class="fas fa-skull-crossbones me-1"></i>Poisonous',
            unknown: '<i class="fas fa-question-circle me-1"></i>Unknown'
        };

        function updateLocationDetails(loc) {
            if (!loc) return;
            detailName.textContent = loc.name || 'Unknown mushroom';
            detailBadge.className = `badge bg-${loc.status || 'unknown'} fs-6 px-3 py-2 shadow-sm`;
            detailBadge.innerHTML = statusLabelMap[loc.status] || statusLabelMap.unknown;
            detailDescription.textContent = loc.description || 'No description provided.';
            if (detailScientific) {
                detailScientific.textContent = loc.scientific_name || 'Not specified.';
            }
            if (detailOrigin) {
                detailOrigin.textContent = loc.origin || 'No origin information provided.';
            }
            detailImage.src = loc.image;
            detailImage.alt = loc.name || 'Mushroom image';
            detailCoords.innerHTML = `<i class="fas fa-map-marker-alt me-2"></i>${loc.lat.toFixed(4)}, ${loc.lng.toFixed(4)}`;
            detailDate.innerHTML = `<i class="fas fa-clock me-2"></i>${loc.date}`;
        }

        locationButtons.forEach(function(btn) {
            btn.addEventListener('click', function() {
                const index = parseInt(btn.getAttribute('data-index'));
                const marker = markers[index];
                if (marker) {
                    map.setView(marker.getLatLng(), 15, { animate: true });
                    marker.openPopup();
                }

                locationButtons.forEach(function(item) { item.classList.remove('active'); });
                btn.classList.add('active');

                updateLocationDetails(locations[index]);
            });
        });

        if (locations.length) {
            updateLocationDetails(locations[0]);
        }
    });
    </script>
</body>
</html>
